<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="what heppens when an octopus aspires to be a hacker? - Hexadecimal + Octopus = 0xtopus the h4x0r!">
    <meta property="og:type" content="website">
    <meta name="description" content="what heppens when an octopus aspires to be a hacker? - Hexadecimal + Octopus = 0xtopus the h4x0r!">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        DSP知识整理 - undefined
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 6.3.0"></head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> h4x0rdecimal 0xtopus </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="/img/avatar.png" />
        </div>
        <div class="name">
            <i>0xtopus</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>收藏</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%80%E3%80%81DSP%E6%A6%82%E8%BF%B0"><span class="toc-text">一、DSP概述</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%EF%BC%9A"><span class="toc-text">硬件：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%EF%BC%9A"><span class="toc-text">软件：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DSP%E5%88%86%E7%B1%BB"><span class="toc-text">DSP分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DSP%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-text">DSP的应用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%8C%E3%80%81TMS320F2812"><span class="toc-text">二、TMS320F2812</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#C2000%E7%B3%BB%E5%88%97DSP"><span class="toc-text">C2000系列DSP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CPU"><span class="toc-text">CPU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98"><span class="toc-text">内存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%80%BB%E7%BA%BF"><span class="toc-text">总线</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E8%AE%BE%E5%8A%9F%E8%83%BD%E6%A8%A1%E5%9D%97"><span class="toc-text">外设功能模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-text">其他</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E5%9D%80%E6%96%B9%E5%BC%8F"><span class="toc-text">寻址方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#C28x%E6%B5%81%E6%B0%B4%E7%BA%BF"><span class="toc-text">C28x流水线</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E6%97%B6%E9%92%9F%E5%92%8C%E7%B3%BB%E7%BB%9F%E6%8E%A7%E5%88%B6"><span class="toc-text">三、时钟和系统控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9C%8B%E9%97%A8%E7%8B%97%E7%94%B5%E8%B7%AF"><span class="toc-text">看门狗电路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%8E%E5%8A%9F%E8%80%97%E6%A8%A1%E5%BC%8F"><span class="toc-text">低功耗模式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E3%80%81CPU%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="toc-text">四、CPU定时器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E7%BC%96%E7%A8%8B"><span class="toc-text">五、编程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E6%96%87%E4%BB%B6"><span class="toc-text">程序文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%96%87%E4%BB%B6"><span class="toc-text">命令文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AD%E3%80%81GPIO"><span class="toc-text">六、GPIO</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%83%E3%80%81%E4%B8%AD%E6%96%AD"><span class="toc-text">七、中断</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-text">中断优先级</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CPU%E7%BA%A7%E4%B8%AD%E6%96%AD"><span class="toc-text">CPU级中断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PIE%E4%B8%AD%E6%96%AD"><span class="toc-text">PIE中断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PIE%E4%B8%AD%E6%96%AD%E5%90%91%E9%87%8F%E8%A1%A8"><span class="toc-text">PIE中断向量表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2812%E7%9A%84%E4%B8%89%E7%BA%A7%E4%B8%AD%E6%96%AD%E7%B3%BB%E7%BB%9F"><span class="toc-text">2812的三级中断系统</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E5%87%BD%E6%95%B0%E7%9A%84%E7%BC%96%E5%86%99"><span class="toc-text">中断函数的编写</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%AB%E3%80%81EV%E6%A8%A1%E5%9D%97%EF%BC%88%E4%BA%8B%E4%BB%B6%E7%AE%A1%E7%90%86%E5%99%A8%EF%BC%89"><span class="toc-text">八、EV模块（事件管理器）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E5%AE%9A%E6%97%B6%E5%99%A8"><span class="toc-text">通用定时器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%9F%E8%83%BD"><span class="toc-text">功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-text">寄存器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E7%94%A8%E5%AE%9A%E6%97%B6%E5%99%A8%E7%9A%84%E6%97%B6%E9%92%9F"><span class="toc-text">通用定时器的时钟</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E6%95%B0%E6%96%B9%E5%BC%8F"><span class="toc-text">计数方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD%E4%BA%8B%E4%BB%B6"><span class="toc-text">中断事件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PWM%E6%B3%A2"><span class="toc-text">PWM波</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E6%AF%94%E8%BE%83%E5%8D%95%E5%85%83"><span class="toc-text">全比较单元</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8-1"><span class="toc-text">寄存器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8D%95%E8%8E%B7%E5%8D%95%E5%85%83"><span class="toc-text">捕获单元</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8-2"><span class="toc-text">寄存器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E6%96%AD"><span class="toc-text">中断</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A3%E4%BA%A4%E7%BC%96%E7%A0%81%E7%94%B5%E8%B7%AF"><span class="toc-text">正交编码电路</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B9%9D%E3%80%81ADC"><span class="toc-text">九、ADC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F"><span class="toc-text">工作方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C%E8%AF%BB%E5%8F%96"><span class="toc-text">结果读取</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%81%E3%80%81SPI"><span class="toc-text">十、SPI</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%96%B9%E5%BC%8F-1"><span class="toc-text">工作方式</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> h4x0rdecimal 0xtopus </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        DSP知识整理
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2023-06-29 08:41:57</span></span>
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <p>推荐参考书籍：《手把手教你学DSP—基于TMS320X281x》（第3版） <em>顾卫钢</em></p>
<h1 id="一、DSP概述"><a href="#一、DSP概述" class="headerlink" title="一、DSP概述"></a>一、DSP概述</h1><h3 id="硬件："><a href="#硬件：" class="headerlink" title="硬件："></a>硬件：</h3><ul>
<li>高速控制和信号处理</li>
<li>采用流水线操作</li>
<li>采用哈佛结构，数据存储区和程序存储区分离，数据总线和程序总线也是分开的</li>
<li>大多配有硬件乘法器和加法器，同一时钟周期内可以完成累加和累乘</li>
<li>零开销循环</li>
</ul>
<h3 id="软件："><a href="#软件：" class="headerlink" title="软件："></a>软件：</h3><ul>
<li>显示MAC（乘加器）指令</li>
<li>精简指令集</li>
<li>专门的寻址方式</li>
</ul>
<h3 id="DSP分类"><a href="#DSP分类" class="headerlink" title="DSP分类"></a>DSP分类</h3><p>按数据格式分：</p>
<ul>
<li>定点</li>
<li>浮点</li>
</ul>
<p>按用途分：</p>
<ul>
<li>通用</li>
<li>专用</li>
</ul>
<h3 id="DSP的应用"><a href="#DSP的应用" class="headerlink" title="DSP的应用"></a>DSP的应用</h3><ol>
<li>数字电机控制</li>
<li>数字电源供应</li>
<li>高级传感器</li>
<li>…</li>
</ol>
<h1 id="二、TMS320F2812"><a href="#二、TMS320F2812" class="headerlink" title="二、TMS320F2812"></a>二、TMS320F2812</h1><h3 id="C2000系列DSP"><a href="#C2000系列DSP" class="headerlink" title="C2000系列DSP"></a>C2000系列DSP</h3><ol>
<li>Piccolo系列<ul>
<li>F2802x, F2803x&#x2F;5x, F2806x</li>
</ul>
</li>
<li>Delfino系列<ul>
<li>F2833x&#x2F;23x, C2834x, F2837xS, F2837xD</li>
</ul>
</li>
</ol>
<h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><ul>
<li>32位定点CPU</li>
<li>150MHz</li>
<li>当频率为135MHz时，核心电压1.8V；当频率为150MHz时，核心电压为1.9V；输出IO口电压为3.3V</li>
</ul>
<h3 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h3><ul>
<li>18kW RAM</li>
<li>128kW Flash</li>
</ul>
<h3 id="总线"><a href="#总线" class="headerlink" title="总线"></a>总线</h3><ul>
<li>3条地址总线<ul>
<li>PAB：程序地址总线，<strong>22位</strong></li>
<li>DRAB：数据读地址总线，32位</li>
<li>DWAB：数据写地址总线，32位</li>
</ul>
</li>
<li>3条数据总线<ul>
<li>DRDB：数据读数据总线，32位</li>
<li>DWDB：数据写数据总线，32位</li>
<li>PRDB：程序读数据总线，32位</li>
</ul>
</li>
</ul>
<h3 id="外设功能模块"><a href="#外设功能模块" class="headerlink" title="外设功能模块"></a>外设功能模块</h3><ul>
<li><p>控制类</p>
<ul>
<li>IO</li>
<li>定时器</li>
<li>PWM</li>
</ul>
</li>
<li><p>测量类</p>
<ul>
<li>数字：捕获、正交编码</li>
<li>模拟：ADC</li>
</ul>
</li>
<li><p>通讯类</p>
<ul>
<li>UART</li>
<li>eCAN</li>
<li>SPI</li>
<li>McBsp</li>
</ul>
</li>
</ul>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>外设中断扩展模块（PIE）</p>
<ul>
<li>支持45个外部中断</li>
</ul>
<p>片上存储器</p>
<ul>
<li>128kW Flash，受到CSM（Code Security Module）保护</li>
<li>1kW的OTP型存储器（一次性可编程ROM），受到CSM的保护；</li>
<li>18kW的SARAM<ul>
<li>L0和L1：两个4kW的SARAM, 受到CSM的保护</li>
<li>H0: 8kW</li>
<li>M0和M1：两个1kW的SARAM</li>
</ul>
</li>
<li>56个可编程IO口</li>
<li>时钟和系统控制</li>
<li>3个32位CPU定时器</li>
<li>马达控制外设<ul>
<li>两个事件管理器</li>
</ul>
</li>
<li>12位ADC，16通道</li>
</ul>
<h3 id="寻址方式"><a href="#寻址方式" class="headerlink" title="寻址方式"></a>寻址方式</h3><ol>
<li>直接寻址</li>
<li>间接寻址</li>
<li>寄存器寻址</li>
<li>堆栈寻址</li>
<li>数据&#x2F;地址&#x2F;IO空间立即寻址方式</li>
<li>程序空间间接寻址方式</li>
</ol>
<h3 id="C28x流水线"><a href="#C28x流水线" class="headerlink" title="C28x流水线"></a>C28x流水线</h3><ul>
<li>八级流水线，五个阶段</li>
<li>取指令，译码，读取数据，执行，写回</li>
</ul>
<h1 id="三、时钟和系统控制"><a href="#三、时钟和系统控制" class="headerlink" title="三、时钟和系统控制"></a>三、时钟和系统控制</h1><p><img src="/../img/DSP/OSC&PLL.png" alt="OSC&amp;PLL"><br>时钟CLKIN的来源有两种，一种是外部晶振提供，另一种是外部时钟输入。可以通过引脚<span style="text-decoration: overline">XF_PLLDIS</span>来控制选择。</p>
<ul>
<li>晶振：20MHz ~ 35MHz</li>
<li>外部时钟：有PLL: 5 ~ 100MHz；无PLL: 4 ~ 150MHz</li>
</ul>
<p>在使用对应的外设之前，需要使能它们的时钟。与外设时钟使能相关的寄存器是<u>外设时钟使能寄存器PCLKCR</u>。</p>
<p>SYSCLK经过分频可以得到低速外设时钟LSPCLK和高速外设时钟HSPCLK，它们互相独立，分别给高速外设和低速外设供应时钟信号。</p>
<img src="..\img\DSP\HSPCLK_LSPCLK.png" style="zoom:75%;" />



<h3 id="看门狗电路"><a href="#看门狗电路" class="headerlink" title="看门狗电路"></a>看门狗电路</h3><p>当八位的<u>看门狗加法计数器WDCNTR</u>达到最大值时，看门狗模块输出一个512个周期的脉冲，使系统复位。</p>
<p>如果不想使用看门狗，可以直接禁止看门狗。</p>
<p>如果启用了看门狗，当程序正常运行时，我们需要定期向WDCNTR依次顺序写入0x55和0xAA来清零，实现“喂狗”操作。</p>
<p>逻辑校验位是看门狗的另一个安全机制，访问<u>看门狗控制器WDCR</u>的写操作中，相应的校验位必须为“101”，否则会立即拒绝访问并引发系统复位。</p>
<h3 id="低功耗模式"><a href="#低功耗模式" class="headerlink" title="低功耗模式"></a>低功耗模式</h3><ul>
<li>空闲模式：CPU进入低功耗模式，部分外设不使用时时钟选择性关闭，会自动降低频率来降低功耗，任何使能的外设中断都可以唤醒此模式。</li>
<li>暂停模式：片上所有设备停止工作</li>
<li>备用模式：关闭CPU和外设时钟，OSC和PLL正常工作</li>
</ul>
<h1 id="四、CPU定时器"><a href="#四、CPU定时器" class="headerlink" title="四、CPU定时器"></a>四、CPU定时器</h1><p>x2812内部有3个32位的CPU定时器，其中只有Timer0可供用户使用，Timer1和Timer2都被系统保留。</p>
<p>欲使用CPU定时器来计时，需要设置两个寄存器：</p>
<ul>
<li>周期寄存器 PRDH:PRD</li>
<li>分频器寄存器 TDDRH:TDDR</li>
</ul>
<p>计数器的周期有以下两个公式：</p>
<p>${TIMCLK &#x3D; \frac{TDDRH:TDDR + 1 }{SYSCLK} * 10^{-6}}$</p>
<p>${Period &#x3D; (PRDH:PRD + 1) * TIMCLK}$</p>
<h1 id="五、编程"><a href="#五、编程" class="headerlink" title="五、编程"></a>五、编程</h1><h2 id="程序文件"><a href="#程序文件" class="headerlink" title="程序文件"></a>程序文件</h2><ul>
<li>源程序文件：C，汇编文件</li>
<li>头文件：.h文件</li>
<li>命令文件(cmd)：对程序和数据存储空间进行分配</li>
<li>运行支持库</li>
</ul>
<h2 id="命令文件"><a href="#命令文件" class="headerlink" title="命令文件"></a>命令文件</h2><p>伪指令：</p>
<ul>
<li>MEMORY：用来指示存储空间<ul>
<li>PAGE0：程序空间</li>
<li>PAGE1：数据空间</li>
</ul>
</li>
<li>SECTION：用来分配到储存空间<ul>
<li>段：<ul>
<li>.cinit：存放用来对全局和静态变量初始化的函数</li>
<li>.text：存放编译C语言时产生的汇编代码</li>
<li>.econst：包含字符串常量、全局变量和静态变量的初始化和说明</li>
<li>.ebss：使用大寄存器模式时为全局变量和静态变量所预留的空间</li>
<li>.stack：为系统堆栈保留的空间，主要用于函数传递变量和为局部变量分配空间。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="六、GPIO"><a href="#六、GPIO" class="headerlink" title="六、GPIO"></a>六、GPIO</h1><p>总共56个可编程复用IO口，分为ABDEFG六组。复位默认为输入口。可提供4mA输入电流。</p>
<p>寄存器：</p>
<ul>
<li>GPxMUX<ul>
<li>写0，设置为数字IO口</li>
<li>写1，功能复用</li>
</ul>
</li>
<li>GPxDIR<ul>
<li>写0，输入</li>
<li>写1，输出</li>
</ul>
</li>
<li>GPxDAT<ul>
<li>写0，拉低输出</li>
<li>写1，拉高输出</li>
<li>存在一定的问题，建议使用下面三个寄存器来操作</li>
</ul>
</li>
<li>GPxSet：只能写1</li>
<li>GPxClear：只能写1</li>
<li>GPxTOGGLE：只能写1</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 置位输出</span></span><br><span class="line">GpioDataReg.GPASET.bit.GPIOA0 = <span class="number">1</span>;</span><br><span class="line"><span class="comment">// 读取输入</span></span><br><span class="line"><span class="keyword">if</span>(GpioDataReg.GPASET.bit.GPIOA2 = <span class="number">0</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="七、中断"><a href="#七、中断" class="headerlink" title="七、中断"></a>七、中断</h1><p>中断的类型：</p>
<ul>
<li>触发形式<ul>
<li>软件中断</li>
<li>硬件中断<ul>
<li>内部中断</li>
<li>外部中断</li>
</ul>
</li>
</ul>
</li>
<li>能否屏蔽<ul>
<li>可屏蔽中断</li>
<li>不可屏蔽中断</li>
</ul>
</li>
</ul>
<h2 id="中断优先级"><a href="#中断优先级" class="headerlink" title="中断优先级"></a>中断优先级</h2><p>在不同组内INT1最大，在PIE同组内，INTx.1最大。</p>
<h2 id="CPU级中断"><a href="#CPU级中断" class="headerlink" title="CPU级中断"></a>CPU级中断</h2><p>CPU中的中断由IER和INTM控制。IER控制每个可屏蔽中断，INTM相当于总闸。</p>
<h2 id="PIE中断"><a href="#PIE中断" class="headerlink" title="PIE中断"></a>PIE中断</h2><p>外设中断扩展模块（PIE），对各种中断请求源进行处理。</p>
<p>PIE一共支持96个中断，这些中断被分为了12个组，每组由8个中断。每个组都被反馈到 <span style="text-decoration:overline" >INT1</span> ~ <span style="text-decoration:overline" >INT12</span> 这12条中断线上的某一条。</p>
<h2 id="PIE中断向量表"><a href="#PIE中断向量表" class="headerlink" title="PIE中断向量表"></a>PIE中断向量表</h2><p>DSP中各个中断服务子程序的地址储存在一片连续的RAM（大小为256x16）内，这就是中断向量表。</p>
<h2 id="2812的三级中断系统"><a href="#2812的三级中断系统" class="headerlink" title="2812的三级中断系统"></a>2812的三级中断系统</h2><p>三级系统都要允许，某中断才会发生。</p>
<ul>
<li><p>外设级</p>
<ul>
<li>当外设中断标志位被置1，且该外设中断为使能状态，此时外设向PIE发出中断请求；</li>
<li><span style="color:red; font-weight:bold">外设中断标志位置位后必须<u>手动清除</u>！！！</span></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CpuTimer0Reg.TCR.bit.TIF = <span class="number">1</span>;	<span class="comment">// 写1来手动清除外设寄存器中的标志位</span></span><br></pre></td></tr></table></figure>


</li>
<li><p>PIE级</p>
<ul>
<li>除了中断标志寄存器和中断使能寄存器，还有中断应答寄存器。</li>
<li>同组内的中断在响应时，如果发生了其他同组中断，若中断应答寄存器没有被手动清零，后发生的中断不会被响应。<span style="color:red; font-weight:bold">中断应答寄存器需要手动清除</span>。PIE级中断的标志位不需要手动清除。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PieCtrl.PIEACK.bit.ACK1 = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>


</li>
<li><p>CPU级</p>
<ul>
<li>当外设中断请求发送到CPU时，CPU的中断标志寄存器IFR对应位置位。这时，CPU检查IER对应的位是否置位，以及INTM是否<span style="color:red; font-weight:bold">为0</span>。</li>
</ul>
</li>
</ul>
<img src="..\img\DSP\INTERRUPTION.png" style="zoom:75%;" />

<h2 id="中断函数的编写"><a href="#中断函数的编写" class="headerlink" title="中断函数的编写"></a>中断函数的编写</h2><ol>
<li>使能某个中断：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">InitXXX</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    CpuTimer0Regs.TCR.bit.TIE = <span class="number">1</span>;	<span class="comment">// 使能定时器0的周期中断</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在主函数里：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    InitXXX();</span><br><span class="line">    DINT;</span><br><span class="line">    IER = <span class="number">0x0000</span>;</span><br><span class="line">    IFR = <span class="number">0x0000</span>;</span><br><span class="line">    InitPieCtrl();</span><br><span class="line">    InitPieVectTable():</span><br><span class="line">    <span class="comment">// 使能PIE的中断</span></span><br><span class="line">    PieCtrl.PIEIER1.bit.INTx7 = <span class="number">1</span>;</span><br><span class="line">    IER |= M_INT1;</span><br><span class="line">    EINT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在DSP28_DefaultIsr.c文件里配置中断函数</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">interrupt <span class="type">void</span> <span class="title function_">TINT0_ISR</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    CpuTimer0Regs.TCR.bit.TIF = <span class="number">1</span>;</span><br><span class="line">    PieCtrl.PIEACK.bit.ACK1 = <span class="number">1</span>;</span><br><span class="line">    EINT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="八、EV模块（事件管理器）"><a href="#八、EV模块（事件管理器）" class="headerlink" title="八、EV模块（事件管理器）"></a>八、EV模块（事件管理器）</h1><p>两个事件管理器Eva和Evb，两个事件管理器的功能是一模一样的。</p>
<p>下面<strong>针对Eva</strong>来介绍事件管理器的结构：</p>
<ul>
<li>2个16位通用定时器，每个定时器可以产生1路独立的PWM波。</li>
<li>3个比较单元</li>
<li>3个捕获单元</li>
<li>1个正交编码脉冲电路</li>
</ul>
<p>Evb和Eva类似。</p>
<h2 id="通用定时器"><a href="#通用定时器" class="headerlink" title="通用定时器"></a>通用定时器</h2><h3 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h3><ol>
<li>计时</li>
<li>使用定时器的比较功能产生PWM波</li>
<li>给Ev的其他模块提供时钟</li>
</ol>
<h3 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h3><p><strong>GPTimer1</strong>的寄存器们be like:</p>
<ul>
<li>16位周期寄存器T1PR（带有阴影寄存器）</li>
<li>16位比较寄存器T1CMPR（带有阴影寄存器）</li>
<li>定时器计数器寄存器T1CNT</li>
<li>16位控制寄存器T1CON</li>
<li>16位通用定时器控制寄存器GPTCONA</li>
</ul>
<h3 id="通用定时器的时钟"><a href="#通用定时器的时钟" class="headerlink" title="通用定时器的时钟"></a>通用定时器的时钟</h3><p>SYSCLK  –&gt; HSPCLK –&gt; TCLK</p>
<p>$TCLK &#x3D; \frac{HSPCLK}{2^{p}}$</p>
<p>其中，p &#x3D; 1 ~ 128</p>
<h3 id="计数方式"><a href="#计数方式" class="headerlink" title="计数方式"></a>计数方式</h3><p>GPTimer1通过T1CON的TMODE1和TMODE0控制计数方式。</p>
<table>
<thead>
<tr>
<th align="center">TMODE1</th>
<th align="center">TMODE0</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">停止&#x2F;保持模式</td>
</tr>
<tr>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">连续增&#x2F;减计数模式</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">连续增计数模式</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">定向增&#x2F;减计数模式</td>
</tr>
</tbody></table>
<p>对定向增&#x2F;减计数模式的说明：当为定向增&#x2F;减计数模式时，计时器工作在递增还是递减模式取决于引脚TDIRA的电平，高电平递增，低电平递减。</p>
<h3 id="中断事件"><a href="#中断事件" class="headerlink" title="中断事件"></a>中断事件</h3><ul>
<li>上溢中断</li>
<li>下溢中断</li>
<li>比较中断</li>
<li>周期中断</li>
</ul>
<h3 id="PWM波"><a href="#PWM波" class="headerlink" title="PWM波"></a>PWM波</h3><p>要产生PWM波：</p>
<ul>
<li>使能定时器的T1CON的TECMPR位为1（比较使能）</li>
<li>GPTCONA的TCMPOE位为1（输出使能）</li>
</ul>
<p>此时，T1PWM_T1CMP引脚输出PWM波。当T1CNT与T1CMPR的值相匹配时，引脚T1PWM_T1CMP电平就会发生跳变。</p>
<p>产生的PWM波有两种：</p>
<ul>
<li>不对称（连续增计数模式）</li>
<li>对称（连续增\减计数模式）</li>
</ul>
<p>可以配置GPTCONA的T1PIN[1:0]位控制输出的极性：</p>
<table>
<thead>
<tr>
<th align="center">位1</th>
<th align="center">位0</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">强制低</td>
</tr>
<tr>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">低电平有效</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">高电平有效</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">强制高</td>
</tr>
</tbody></table>
<p>低电平有效就是T1CNT的值比T1CMPR小的时候输出高电平，其他以此类推。</p>
<p>定时器的周期为：</p>
<p>非对称模式：</p>
<p>$T &#x3D; (T1PR + 1) * TCLK$</p>
<p>对称模式：</p>
<p>$T &#x3D; (2 * T1PR) *TCLK$</p>
<h2 id="全比较单元"><a href="#全比较单元" class="headerlink" title="全比较单元"></a>全比较单元</h2><p>Eva、Evb各有3个全比较单元（加起来总共6个），每个比较单元都可以输出2路互补的PWM波，所以Eva或者Evb可以都有能力驱动一个三相全桥电路。（当然你也可以设置输出的两路PWM相同）</p>
<h3 id="寄存器-1"><a href="#寄存器-1" class="headerlink" title="寄存器"></a>寄存器</h3><p>按Eva和Evb来分：</p>
<ul>
<li>16位比较寄存器CMPR1<del>3， CMPR4</del>6，共6个（都有阴影寄存器）</li>
<li>16位比较控制寄存器COMCONA和COMCONB，共2个</li>
<li>16位行为控制寄存器ACTRA和ACTRB（都有阴影寄存器）</li>
</ul>
<p>以Eva为例，输出的PWM极性可以通过ACTRA的位CMP1和CMP2控制。使能COMCONA的CENABLE和FCMPOE位时即可产生两路互补的PWM波。</p>
<p>每个比较寄存器都有两个对应的PWM输出引脚：比如CMPR1对应PWM1和PWM2</p>
<p>输出的PWM波类型和GPTimer是一样的。只是把T1CMPR改成CMPRx即可。</p>
<p>带有死区控制的PWM不考，不写了。</p>
<h2 id="捕获单元"><a href="#捕获单元" class="headerlink" title="捕获单元"></a>捕获单元</h2><p>捕获单元能够捕获外部输入引脚CAPx_QEPx的电平变化。当捕获到指定的电平变化时，捕获单元就记录下定时器的时间。利用两次捕获的时间差，捕获单元就可以测量出信号的脉宽。</p>
<p>2812的Eva和Evb各有三个捕获单元CAP1 ~ 3和CAP4 ~ 6。每个捕获单元都有一个捕获输入</p>
<p>引脚，通过配置相关寄存器可以捕获输入波形的上升沿、下降沿或者同时捕获上升沿和下降沿。当引脚检测到指定的变化时，所选用的定时器的值将被捕获并锁存到对应的2级FIFO堆栈中。注意，从引脚发生变化到锁存定时器的值需要至少2个时钟周期，所以<strong>输入信号至少要保持2个时钟周期</strong>。</p>
<h3 id="寄存器-2"><a href="#寄存器-2" class="headerlink" title="寄存器"></a>寄存器</h3><ul>
<li>捕获控制寄存器CAPCONA, CAPCONB</li>
<li>捕获FIFO状态寄存器CAPFIFOA， CAPFIFOB</li>
<li>两级深度的FIFO堆栈CAPFIFOx, CAPFBOTx (x &#x3D; 1 ~ 6)</li>
</ul>
<p>以Eva的CAP1为例，在堆栈为空的时候，捕获状态寄存器CAPFIFOA的CAP1FIFO状态位为00，发生一次捕获后，定时器计数寄存器T1CNT的值被存入栈顶，CAP1FIFO状态位为01，第二次捕获后，数据存入栈底，堆栈全满，CAP1FIFO状态位变为10；第三次捕获后，栈顶的数据出栈，第二次捕获的来到栈顶，第三次捕获的来到栈底。如果没有读取第一次捕获的值（第一次捕获的值丢失），则CAP1FIFO状态位变为11；否则如果在第三次捕获前已经读取了第一次捕获的值，则CAP1FIFO状态位仍为10.</p>
<h3 id="中断"><a href="#中断" class="headerlink" title="中断"></a>中断</h3><p>以Eva为例，捕获单元1具有捕获中断CAP1INT，捕获单元2有CAP2INT，捕获单元3有CAP3INT…</p>
<p>中断发生的条件：</p>
<ol>
<li>捕获单元捕获到信号发生指定的变化</li>
<li>此时CAPxFIFO不为0（堆栈非空）</li>
</ol>
<p>则此时中断标志位被置位。</p>
<p>和中断相关的寄存器：</p>
<ul>
<li>中断标志寄存器EVAIFRC，EVBIFRC</li>
<li>中断屏蔽寄存器EVAIMRC和EVBIMRC（用来使能中断的）</li>
</ul>
<h2 id="正交编码电路"><a href="#正交编码电路" class="headerlink" title="正交编码电路"></a>正交编码电路</h2><p>每个事件管理器都有一个正交编码电路（QEP电路），光电码盘输出的两路正交编码信号从两个输入引脚输入到QEP电路，在通过两个QEP电路的译码器对正交编码信号进行译码，最后就能得到电机转子的转速、旋转方向、旋转位置等信息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 自己写的事件管理器Init函数</span></span><br><span class="line"><span class="comment"> * 配置了全比较单元输出PWM波和捕获单元捕获上升下降沿</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">InitEv</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 配置GP Timer2</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	EvaRegs.T2CON.bit.TENABLE = <span class="number">0</span>; 	<span class="comment">// 暂时禁止t2计数</span></span><br><span class="line">	EvaRegs.T2CON.bit.TPS = <span class="number">0</span>;			<span class="comment">// 输入计数时钟为HSPCLK = 75MHz</span></span><br><span class="line">	EvaRegs.T2CON.bit.TMODE = <span class="number">2</span>; 		<span class="comment">// GP Timer2连续增计数模式</span></span><br><span class="line">	EvaRegs.T2CON.bit.TCLKS10 = <span class="number">0</span>; 	<span class="comment">// 选择内部时钟T2CLK</span></span><br><span class="line"></span><br><span class="line">	EvaRegs.T2CNT = <span class="number">0x0000</span>;	<span class="comment">// Clear the counter for GP timer 2</span></span><br><span class="line">	EvaRegs.T2PR = <span class="number">0x3A97</span>;		<span class="comment">// 频率为5kHz，PR = 14999</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * GP Timer2周期中断配置</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	EvaRegs.EVAIMRB.bit.T2PINT = <span class="number">1</span>;		<span class="comment">// 使能GP Timer2周期中断</span></span><br><span class="line">	EvaRegs.EVAIFRB.bit.T2PINT = <span class="number">1</span>;			<span class="comment">// 复位GP Timer2周期中断标志位</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 配置GP Timer1</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	EvaRegs.T1CON.bit.TENABLE = <span class="number">0</span>; 	<span class="comment">// 暂时禁止t1计数</span></span><br><span class="line">	EvaRegs.T1CON.bit.TPS = <span class="number">0</span>;			<span class="comment">// 输入计数时钟为HSPCLK = 75MHz</span></span><br><span class="line">	EvaRegs.T1CON.bit.TMODE = <span class="number">2</span>; 		<span class="comment">// GP Timer1连续增计数模式</span></span><br><span class="line">	EvaRegs.T1CON.bit.TCLKS10 = <span class="number">0</span>; 	<span class="comment">// 选择内部时钟T1CLK</span></span><br><span class="line"></span><br><span class="line">	EvaRegs.T1CNT = <span class="number">0x0000</span>;		<span class="comment">// Clear the counter for GP timer 1</span></span><br><span class="line">	EvaRegs.T1PR = <span class="number">0x3A97</span>;		<span class="comment">// 频率为5kHz，PR = 14999</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 配置全比较模块</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	EvaRegs.COMCONA.bit.CENABLE = <span class="number">1</span>;		<span class="comment">// 使能EVA的全比较操作</span></span><br><span class="line">	EvaRegs.COMCONA.bit.FCOMPOE = <span class="number">1</span>;	<span class="comment">// 使能比较输出</span></span><br><span class="line"></span><br><span class="line">	EvaRegs.COMCONA.bit.CLD = <span class="number">0</span>;				<span class="comment">// 比较寄存器重载条件为下溢中断</span></span><br><span class="line"></span><br><span class="line">	EvaRegs.CMPR1 = <span class="number">0x1D4C</span>;	<span class="comment">// 默认占空比为50%</span></span><br><span class="line">	EvaRegs.CMPR2 = <span class="number">0x1D4C</span>;	<span class="comment">// 默认占空比为50%</span></span><br><span class="line">	EvaRegs.CMPR3 = <span class="number">0x1D4C</span>;	<span class="comment">// 默认占空比为50%</span></span><br><span class="line">	EvaRegs.ACTR.all = <span class="number">0</span>;			<span class="comment">// 全部强制低</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * GP Timer1下溢中断配置</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	EvaRegs.EVAIMRA.bit.T1UFINT = <span class="number">1</span>;		<span class="comment">// 使能GP Timer1下溢中断</span></span><br><span class="line">	EvaRegs.EVAIFRA.bit.T1UFINT = <span class="number">1</span>;		<span class="comment">// 复位GP Timer1下溢中断标志位</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    EvaRegs.CAPFIFO.all = <span class="number">0</span>; <span class="comment">// 初始化CAPFIFOA</span></span><br><span class="line"></span><br><span class="line">	EvaRegs.CAPCON.bit.CAPRES = <span class="number">0</span>; 			<span class="comment">// 清零捕获寄存器</span></span><br><span class="line">	EvaRegs.CAPCON.bit.CAPQEPN = <span class="number">1</span>; 		<span class="comment">// 使能捕获单元1,2</span></span><br><span class="line">	EvaRegs.CAPCON.bit.CAP3EN = <span class="number">1</span>;			<span class="comment">// 使能捕获单元3</span></span><br><span class="line">	EvaRegs.CAPCON.bit.CAP3TSEL = <span class="number">1</span>;		<span class="comment">// 捕获单元3时基为timer1</span></span><br><span class="line">	EvaRegs.CAPCON.bit.CAP12TSEL = <span class="number">1</span>;		<span class="comment">// 捕获单元1,2时基为timer1</span></span><br><span class="line"></span><br><span class="line">	EvaRegs.CAPCON.bit.CAP1EDGE = <span class="number">0x3</span>;	<span class="comment">// 捕获单元1捕获边沿为上升下降沿</span></span><br><span class="line">	EvaRegs.CAPCON.bit.CAP2EDGE = <span class="number">0x3</span>;	<span class="comment">// 捕获单元2捕获边沿为上升下降沿</span></span><br><span class="line">	EvaRegs.CAPCON.bit.CAP3EDGE = <span class="number">0x3</span>;	<span class="comment">// 捕获单元3捕获边沿为上升下降沿</span></span><br><span class="line"></span><br><span class="line">	EvaRegs.EVAIMRC.bit.CAP1INT = <span class="number">1</span>;		<span class="comment">// 使能捕获单元1中断</span></span><br><span class="line">	EvaRegs.EVAIMRC.bit.CAP2INT = <span class="number">1</span>;		<span class="comment">// 使能捕获单元2中断</span></span><br><span class="line">	EvaRegs.EVAIMRC.bit.CAP3INT = <span class="number">1</span>;		<span class="comment">// 使能捕获单元3中断</span></span><br><span class="line">	EvaRegs.EVAIFRC.all = <span class="number">0x7</span>;		<span class="comment">// 复位捕获单元中断标志位</span></span><br><span class="line"></span><br><span class="line">	EvaRegs.T1CON.bit.TENABLE = <span class="number">1</span>; 	<span class="comment">// 使能t1计数</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="九、ADC"><a href="#九、ADC" class="headerlink" title="九、ADC"></a>九、ADC</h1><ul>
<li><p>2812的ADC分辨率为12bit，具有流水线结构，具有16个通道，分为2组：一组为ADCINA0 ~ ADCINA7，另一组为ADCINB0 ~ ADCINB7，分别对应两个采样保持器。虽然通道很多，但是转换器只有一个，所以要对各通道进行排序转换。</p>
</li>
<li><p>ADC模块的时钟最高频率为25MHz，最高采样率为12.5MSPS（sample per second）。</p>
</li>
<li><p>ADC电压的采样范围是<u>0 ~ 3 V</u></p>
</li>
<li><p>ADC模块对一个序列的通道开始转换必须要有一个启动信号来触发，当信号到来时，相应的序列发生器就开始对内部预先指定的通道进行转换。</p>
</li>
<li><p>ADC有两种工作模式：</p>
<ul>
<li>两个独立的8通道</li>
<li>级联16个通道</li>
</ul>
</li>
<li><p>ADC共有16个结果寄存器来存储转换的数值。</p>
</li>
</ul>
<h2 id="工作方式"><a href="#工作方式" class="headerlink" title="工作方式"></a>工作方式</h2><p>通过16位的ADC输入通道选择序列控制寄存器ADCCHSELSEQx（x&#x3D;1, 2, 3, 4）可以控制ADC通道的<u>转换顺序</u>。</p>
<p>每个ADCCHSELSEQx被分为了4段，每段其名为：CONVxx（x &#x3D; 00 ~ 15）。</p>
<ul>
<li>当ADC工作在<strong>双序列发生器模式</strong>下时，序列发生器SEQ1使用ADCCHSELSEQ1和2，每个CONVx可以选择的通道为ADCINA0 ~ 7；SEQ2使用ADCCHSELSEQ3和4，每个CONVx可以选择的通道为ADCINB0 ~ 7;</li>
<li>当ADC工作在<strong>级联模式</strong>下时则都可自由选择。</li>
</ul>
<p>ADC转换的<u>通道数量</u>由最大通道转换寄存器ADCMAXCONV决定。</p>
<ul>
<li>当工作在双序列发生器模式下时，该寄存器的低三位[0:2]所代表的<strong>二进制数 + 1</strong>决定SEQ1序列发生器转换的通道数量；[4:6]位决定SEQ2转换的通道数量。</li>
<li>工作在级联模式下时，低四位[0:3]决定转换通道的数量，为其代表的<strong>二进制数 + 1</strong></li>
</ul>
<p>ADC还有顺序采样和并发采样两种采样方式，所以排列组合一下，就有：</p>
<ul>
<li>双通道顺序采样</li>
<li>级联顺序采样</li>
<li>双通道并发采样</li>
<li>级联并发采样</li>
</ul>
<p>四种模式。</p>
<p>下面是一个配置双序列顺序采样的例子：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">AdcRegs.ADCTRL1.bit.SEQ_CASC = <span class="number">0</span>; <span class="comment">//独立双排序模式</span></span><br><span class="line">AdcRegs.ADCTRL1.bit.CONT_RUN = <span class="number">0</span>; <span class="comment">//启动停止模式</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 级联双排序的排序器配置</span></span><br><span class="line">AdcRegs.MAX_CONV.bit.MAX_CONV = <span class="number">0x0032</span>; <span class="comment">// B组采样通道为4，A组采样通道为3</span></span><br><span class="line">AdcRegs.CHSELSEQ1.bit.CONV00 = <span class="number">0x0</span>; <span class="comment">// 选择模拟通道ADCINA0</span></span><br><span class="line">AdcRegs.CHSELSEQ1.bit.CONV01 = <span class="number">0x1</span>; <span class="comment">// 选择模拟通道ADCINA1</span></span><br><span class="line">AdcRegs.CHSELSEQ1.bit.CONV02 = <span class="number">0x2</span>; <span class="comment">// 选择模拟通道ADCINA2</span></span><br><span class="line"></span><br><span class="line">AdcRegs.CHSELSEQ3.bit.CONV08 = <span class="number">0xB</span>; <span class="comment">// 选择模拟通道ADCINB3</span></span><br><span class="line">AdcRegs.CHSELSEQ3.bit.CONV08 = <span class="number">0xC</span>; <span class="comment">// 选择模拟通道ADCINB4	</span></span><br><span class="line">AdcRegs.CHSELSEQ3.bit.CONV08 = <span class="number">0xD</span>; <span class="comment">// 选择模拟通道ADCINB5</span></span><br><span class="line">AdcRegs.CHSELSEQ3.bit.CONV08 = <span class="number">0xE</span>; <span class="comment">// 选择模拟通道ADCINB6</span></span><br></pre></td></tr></table></figure>

<p>序列发生器的工作模式有两种：启停模式和连续转换模式。由ADCTRL1的CONT_RUN位控制。在连续转换模式下，当一次序列转换结束后，会自动从该序列头部开始重新进行转换。当工作在启停模式下的时候，序列发生器完成一次转换后会停留在最后状态，需要先<strong>手动复位</strong>后才能在下一次SOC（start of conversion）信号到来时才会重新开始转换。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AdcRegs.ADCTRL2.bit.RST_SEQ1 = <span class="number">1</span>;  <span class="comment">// 手动复位序列发生器</span></span><br></pre></td></tr></table></figure>

<h2 id="结果读取"><a href="#结果读取" class="headerlink" title="结果读取"></a>结果读取</h2><p>ADC的采样结果存储在16个16位的ADC结果寄存器里，左对齐，结果占据高12位，所以计算的时候需要右移4位。</p>
<p>$(ADResult &gt;&gt; 4) &#x3D; \frac{(V_{i}  - ADCCLO)}{3 V} *4095$</p>
<p>ADCLO一般接模拟地，所以为0：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res = (AdcRegs.RESULT0 &gt;&gt; <span class="number">4</span>) / <span class="number">4095</span> * <span class="number">3</span>;</span><br></pre></td></tr></table></figure>



<h1 id="十、SPI"><a href="#十、SPI" class="headerlink" title="十、SPI"></a>十、SPI</h1><p>串行外设接口，是一种<strong>低速同步串行通信接口</strong>，而SCI是同步通信。</p>
<ul>
<li>异步通信和同步通信的区别在于<strong>收发双方是否使用同一个时钟信号来控制数据收、发移位操作</strong>。</li>
</ul>
<h2 id="工作方式-1"><a href="#工作方式-1" class="headerlink" title="工作方式"></a>工作方式</h2><p>SPI总线至少包含一根时钟线和数据线。2812使用4线制SPI，以主从方式进行工作，全双工通信。通信系统中通常有一个主设备和多个从设备。</p>
<table>
<thead>
<tr>
<th align="center">线路名称</th>
<th align="center">功能</th>
</tr>
</thead>
<tbody><tr>
<td align="center">SCK</td>
<td align="center">串行时钟线（主设备控制）</td>
</tr>
<tr>
<td align="center">MISO</td>
<td align="center">主机输入&#x2F;从机输出</td>
</tr>
<tr>
<td align="center">MOSI</td>
<td align="center">主机输出&#x2F;从机输入</td>
</tr>
<tr>
<td align="center"><span style="text-decoration:overline">CS</span></td>
<td align="center">是低电平有效的从机选择线</td>
</tr>
</tbody></table>
<p>SPI的波特率 &#x3D; SPICLK &lt;&#x3D; LSPCLK&#x2F;4。实际使用时要确保小于从机的最大允许速率。</p>
<img src="..\img\DSP\spi.png" alt="spi" style="zoom:75%;" />


        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/AirCloud">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






</html>
